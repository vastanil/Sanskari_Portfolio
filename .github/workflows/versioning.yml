name: Auto-Increment Patch Tag

on:
  push:
    branches:
      - '**'

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git identity
        run: |
          git config --global user.name "Anil Doke"
          git config --global user.email "anild@valueaddsofttech.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

      - name: Get latest tag and create next tag
        run: |
          set -e

          # Get the latest tag or use v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "üîç Latest tag is $LATEST_TAG"

          # Parse version
          VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Increment patch
          PATCH=$((PATCH + 1))

          # Compose new tag
          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "‚ú® New tag will be $NEW_TAG"

          # Check if tag already exists
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $NEW_TAG already exists. Skipping."
            exit 0
          fi

          # Dry run push check
          if ! git push --dry-run origin HEAD:refs/tags/"$NEW_TAG"; then
            echo "‚ùå You do not have permission to push $NEW_TAG"
            exit 1
          fi

          # Create and push new tag
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"

          echo "‚úÖ Pushed new tag: $NEW_TAG"
